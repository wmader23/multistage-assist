alias: Timebox Entity State
icon: mdi:timelapse
mode: parallel
max: 10
fields:
  target_entity:
    description: Entity to control
    example: light.kitchen
  value:
    description: The numeric value (Brightness %, Position %, Temp, Speed %)
    example: 50
  action:
    description: Action to perform (on, off) - alternative to value
    example: on
  minutes:
    description: Duration in minutes
    example: 10
  seconds:
    description: Duration in seconds
    example: 0
  scene_id:
    description: Scene ID for snapshot (lowercase, avoids ULID uppercase issue)
    example: snapshot_a8f7b3c2e1d4f609
sequence:
  - variables:
      # Use passed scene_id or fall back to lowercase context.id
      snapshot_id: "{{ scene_id | default('snapshot_' ~ context.id | lower) }}"
      # Check if this is an automation (scenes don't work for automations)
      is_automation: "{{ target_entity.startswith('automation.') }}"
      # Save original state for automations
      original_state: "{{ states(target_entity) }}"
  
  # For non-automations, create a scene snapshot
  - if:
      - condition: template
        value_template: "{{ not is_automation }}"
    then:
      - action: scene.create
        data:
          scene_id: "{{ snapshot_id }}"
          snapshot_entities:
            - "{{ target_entity }}"
  
  # Apply the requested action
  - choose:
      # On/Off actions (HassTurnOn/HassTurnOff)
      - conditions:
          - condition: template
            value_template: "{{ action is defined and action == 'on' }}"
        sequence:
          - action: homeassistant.turn_on
            target:
              entity_id: "{{ target_entity }}"
      - conditions:
          - condition: template
            value_template: "{{ action is defined and action == 'off' }}"
        sequence:
          - action: homeassistant.turn_off
            target:
              entity_id: "{{ target_entity }}"
      # Value-based actions (brightness, position, etc.)
      - conditions:
          - condition: template
            value_template: "{{ target_entity.startswith('light.') and value is defined }}"
        sequence:
          - action: light.turn_on
            target:
              entity_id: "{{ target_entity }}"
            data:
              brightness_pct: "{{ value }}"
      - conditions:
          - condition: template
            value_template: "{{ target_entity.startswith('cover.') and value is defined }}"
        sequence:
          - action: cover.set_cover_position
            target:
              entity_id: "{{ target_entity }}"
            data:
              position: "{{ value }}"
      - conditions:
          - condition: template
            value_template: "{{ target_entity.startswith('fan.') and value is defined }}"
        sequence:
          - action: fan.set_percentage
            target:
              entity_id: "{{ target_entity }}"
            data:
              percentage: "{{ value }}"
      - conditions:
          - condition: template
            value_template: "{{ target_entity.startswith('climate.') and value is defined }}"
        sequence:
          - action: climate.set_temperature
            target:
              entity_id: "{{ target_entity }}"
            data:
              temperature: "{{ value }}"
  
  # Wait for the specified duration
  - delay:
      minutes: "{{ minutes | default(0) }}"
      seconds: "{{ seconds | default(0) }}"
  
  # Restore original state
  - choose:
      # For automations, restore directly (scenes don't work)
      - conditions:
          - condition: template
            value_template: "{{ is_automation }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ original_state == 'on' }}"
            then:
              - action: automation.turn_on
                target:
                  entity_id: "{{ target_entity }}"
            else:
              - action: automation.turn_off
                target:
                  entity_id: "{{ target_entity }}"
    # For other entities, use the scene
    default:
      - action: scene.turn_on
        target:
          entity_id: "scene.{{ snapshot_id }}"
description: "Temporarily changes an entity state and restores it after a duration"

